(function(b){b.fn.markItUp=function(s,p){var e,k,l,t;k=l=t=false;e={id:"",nameSpace:"",root:"",previewInWindow:"",previewAutoRefresh:true,previewPosition:"after",previewTemplatePath:"~/templates/preview.html",previewParserPath:"",previewParserVar:"data",resizeHandle:true,beforeInsert:"",afterInsert:"",onEnter:{},onShiftEnter:{},onCtrlEnter:{},onTab:{},markupSet:[{}]};b.extend(e,s,p);e.root||b("script").each(function(v,y){miuScript=b(y).get(0).src.match(/(.*)jquery\.markitup(\.pack)?\.js$/);if(miuScript!==
null)e.root=miuScript[1]});return this.each(function(){function v(a,c){if(c)return a.replace(/("|')~\//g,"$1"+e.root);return a.replace(/^~\//,e.root)}function y(a){var c=b("<ul></ul>"),g=0;b("li:hover > ul",c).css("display","block");b.each(a,function(){var d=this,j="",z,A;z=d.key?(d.name||"")+" [Ctrl+"+d.key+"]":d.name||"";key=d.key?'accesskey="'+d.key+'"':"";if(d.separator)j=b('<li class="markItUpSeparator">'+(d.separator||"")+"</li>").appendTo(c);else{g++;for(A=w.length-1;A>=0;A--)j+=w[A]+"-";j=
b('<li class="markItUpButton markItUpButton'+j+g+" "+(d.className||"")+'"><a href="" '+key+' title="'+z+'">'+(d.name||"")+"</a></li>").bind("contextmenu",function(){return false}).click(function(){return false}).bind("focusin",function(){f.focus()}).mousedown(function(){d.call&&eval(d.call)();setTimeout(function(){u(d)},1);return false}).hover(function(){b("> ul",this).show();b(document).one("click",function(){b("ul ul",B).hide()})},function(){b("> ul",this).hide()}).appendTo(c);if(d.dropMenu){w.push(g);
b(j).addClass("markItUpDropMenu").append(y(d.dropMenu))}}});w.pop();return c}function L(a){if(a){a=a.toString();a=a.replace(/\(\!\(([\s\S]*?)\)\!\)/g,function(c,g){var d=g.split("|!|");return t===true?d[1]!==undefined?d[1]:d[0]:d[1]===undefined?"":d[0]});return a=a.replace(/\[\!\[([\s\S]*?)\]\!\]/g,function(c,g){var d=g.split(":!:");if(x===true)return false;value=prompt(d[0],d[1]?d[1]:"");if(value===null)x=true;return value})}return""}function m(a){if(b.isFunction(a))a=a(q);return L(a)}function C(a){var c=
m(o.openWith),g=m(o.placeHolder),d=m(o.replaceWith),j=m(o.closeWith);if(d!=="")block=c+d+j;else if(selection===""&&g!=="")block=c+g+j;else{a=a||selection;block=a.match(/ $/)?c+a.replace(/ $/,"")+j+" ":c+a+j}return{block:block,openWith:c,replaceWith:d,placeHolder:g,closeWith:j}}function u(a){var c,g;q=o=a;D();b.extend(q,{line:"",root:e.root,textarea:h,selection:selection||"",caretPosition:i,ctrlKey:k,shiftKey:l,altKey:t});m(e.beforeInsert);m(o.beforeInsert);k===true&&l===true&&m(o.beforeMultiInsert);
b.extend(q,{line:1});if(k===true&&l===true){lines=selection.split(/\r?\n/);a=0;c=lines.length;for(g=0;g<c;g++)if(b.trim(lines[g])!==""){b.extend(q,{line:++a,selection:lines[g]});lines[g]=C(lines[g]).block}else lines[g]="";string={block:lines.join("\n")};start=i;a=string.block.length+(b.browser.opera?c-1:0)}else if(k===true){string=C(selection);start=i+string.openWith.length;a=string.block.length-string.openWith.length-string.closeWith.length;a-=string.block.match(/ $/)?1:0;a-=F(string.block)}else if(l===
true){string=C(selection);start=i;a=string.block.length;a-=F(string.block)}else{string=C(selection);start=i+string.block.length;a=0;start-=F(string.block)}if(selection===""&&string.replaceWith===""){n+=G(string.block);start=i+string.openWith.length;a=string.block.length-string.openWith.length-string.closeWith.length;n=f.val().substring(i,f.val().length).length;n-=G(f.val().substring(0,i))}b.extend(q,{caretPosition:i,scrollPosition:E});if(string.block!==selection&&x===false){c=string.block;if(document.selection)document.selection.createRange().text=
c;else h.value=h.value.substring(0,i)+c+h.value.substring(i+selection.length,h.value.length);H(start,a)}else n=-1;D();b.extend(q,{line:"",selection:selection});k===true&&l===true&&m(o.afterMultiInsert);m(o.afterInsert);m(e.afterInsert);r&&e.previewAutoRefresh&&M();l=t=k=x=false}function G(a){if(b.browser.opera)return a.length-a.replace(/\n*/g,"").length;return 0}function F(a){if(b.browser.msie)return a.length-a.replace(/\r/g,"").length;return 0}function H(a,c){if(h.createTextRange){if(b.browser.opera&&
b.browser.version>=9.5&&c==0)return false;range=h.createTextRange();range.collapse(true);range.moveStart("character",a);range.moveEnd("character",c);range.select()}else h.setSelectionRange&&h.setSelectionRange(a,a+c);h.scrollTop=E;h.focus()}function D(){h.focus();E=h.scrollTop;if(document.selection){selection=document.selection;if(b.browser.msie){var a=selection.createRange(),c=a.duplicate();c.moveToElementText(h);c.setEndPoint("EndToEnd",a);c=c.text.length-a.text.length;i=c-(h.value.substr(0,c).length-
h.value.substr(0,c).replace(/\r/g,"").length);selection=a.text}else i=h.selectionStart}else{i=h.selectionStart;selection=h.value.substring(i,h.selectionEnd)}return selection}function M(){if(e.previewParserPath!=="")b.ajax({type:"POST",dataType:"text",global:false,url:e.previewParserPath,data:e.previewParserVar+"="+encodeURIComponent(f.val()),success:function(a){I(v(a,1))}});else N||b.ajax({url:e.previewTemplatePath,dataType:"text",global:false,success:function(a){I(v(a,1).replace(/<\!-- content --\>/g,
f.val()))}});return false}function I(a){if(r.document){try{sp=r.document.documentElement.scrollTop}catch(c){sp=0}r.document.open();r.document.write(a);r.document.close();r.document.documentElement.scrollTop=sp}}function J(a){l=a.shiftKey;t=a.altKey;k=!(a.altKey&&a.ctrlKey)?a.ctrlKey:false;if(a.type==="keydown"){if(k===true){li=b("a[accesskey="+String.fromCharCode(a.keyCode)+"]",B).parent("li");if(li.length!==0){k=false;setTimeout(function(){li.triggerHandler("mousedown")},1);return false}}if(a.keyCode===
13||a.keyCode===10)if(k===true){k=false;u(e.onCtrlEnter);return e.onCtrlEnter.keepDefault}else if(l===true){l=false;u(e.onShiftEnter);return e.onShiftEnter.keepDefault}else{u(e.onEnter);return e.onEnter.keepDefault}if(a.keyCode===9){if(l==true||k==true||t==true)return false;if(n!==-1){D();n=f.val().length-n;H(n,0);n=-1;return false}else{u(e.onTab);return e.onTab.keepDefault}}}}var f,h,w,E,i,n,o,q,B,K,r,N,x;f=b(this);h=this;w=[];x=false;E=i=0;n=-1;e.previewParserPath=v(e.previewParserPath);e.previewTemplatePath=
v(e.previewTemplatePath);(function(){nameSpace=id="";if(e.id)id='id="'+e.id+'"';else if(f.attr("id"))id='id="markItUp'+f.attr("id").substr(0,1).toUpperCase()+f.attr("id").substr(1)+'"';if(e.nameSpace)nameSpace='class="'+e.nameSpace+'"';f.wrap("<div "+nameSpace+"></div>");f.wrap("<div "+id+' class="markItUp"></div>');f.wrap('<div class="markItUpContainer"></div>');f.addClass("markItUpEditor");B=b('<div class="markItUpHeader"></div>').insertBefore(f);b(y(e.markupSet)).appendTo(B);K=b('<div class="markItUpFooter"></div>').insertAfter(f);
if(e.resizeHandle===true&&b.browser.safari!==true){resizeHandle=b('<div class="markItUpResizeHandle"></div>').insertAfter(f).bind("mousedown",function(a){var c=f.height(),g=a.clientY,d,j;d=function(z){f.css("height",Math.max(20,z.clientY+c-g)+"px");return false};j=function(){b("html").unbind("mousemove",d).unbind("mouseup",j);return false};b("html").bind("mousemove",d).bind("mouseup",j)});K.append(resizeHandle)}f.keydown(J).keyup(J);f.bind("insertion",function(a,c){c.target!==false&&D();h===b.markItUp.focused&&
u(c)});f.focus(function(){b.markItUp.focused=this})})()})};b.fn.markItUpRemove=function(){return this.each(function(){var s=b(this).unbind().removeClass("markItUpEditor");s.parent("div").parent("div.markItUp").parent("div").replaceWith(s)})};b.markItUp=function(s){var p={target:false};b.extend(p,s);if(p.target)return b(p.target).each(function(){b(this).focus();b(this).trigger("insertion",[p])});else b("textarea").trigger("insertion",[p])}})(jQuery);
